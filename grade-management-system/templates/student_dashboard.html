{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="list-group">
            <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list">个人信息</a>
            <a href="#courses" class="list-group-item list-group-item-action" data-bs-toggle="list">课程列表</a>
            <a href="#my-courses" class="list-group-item list-group-item-action" data-bs-toggle="list">我的课程</a>
            <a href="#grades" class="list-group-item list-group-item-action" data-bs-toggle="list">我的成绩</a>
        </div>
    </div>
    <div class="col-md-9">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="profile">
                <div class="card">
                    <div class="card-header">
                        <h4>个人信息</h4>
                    </div>
                    <div class="card-body">
                        <p><strong>用户名：</strong> {{ current_user.username }}</p>
                        <p><strong>姓名：</strong> {{ current_user.name }}</p>
                        <p><strong>邮箱：</strong> {{ current_user.email }}</p>
                        <p><strong>角色：</strong> 学生</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="courses">
                <div class="card">
                    <div class="card-header">
                        <h4>可选课程</h4>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>课程名称</th>
                                    <th>授课教师</th>
                                    <th>最大人数</th>
                                    <th>已报名人数</th>
                                    <th>剩余名额</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in all_courses %}
                                <tr data-course-id="{{ course.id }}">
                                    <td>{{ course.name }}</td>
                                    <td>{{ course.teacher.name if course.teacher else '未分配' }}</td>
                                    <td>{{ course.max_students }}</td>
                                    <td>{{ course.enrollments|selectattr('is_active', 'equalto', True)|list|length }}</td>
                                    <td>{{ course.max_students - (course.enrollments|selectattr('is_active', 'equalto', True)|list|length) }}</td>
                                    <td>
                                        {% set enrollment_for_course = student_enrollments.get(course.id) %}
                                        {% if course.enrollments|selectattr('is_active', 'equalto', True)|list|length >= course.max_students %}
                                            <button class="btn btn-sm btn-secondary" disabled>名额已满</button>
                                        {% elif enrollment_for_course and enrollment_for_course.operation_count >= 3 %}
                                            <button class="btn btn-sm btn-secondary" disabled>已达操作上限</button>
                                        {% elif enrollment_for_course and enrollment_for_course.is_active %}
                                            <button class="btn btn-sm btn-secondary" disabled>已报名</button>
                                        {% else %}
                                            <button class="btn btn-sm btn-primary enroll-course-btn">报名</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="my-courses">
                <div class="card">
                    <div class="card-header">
                        <h4>我的课程</h4>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>课程名称</th>
                                    <th>授课教师</th>
                                    <th>成绩</th>
                                    <th>操作次数</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in current_user.enrollments if enrollment.is_active %}
                                <tr>
                                    <td>{{ enrollment.course.name }}</td>
                                    <td>{{ enrollment.course.teacher.name if enrollment.course.teacher else '未分配' }}</td>
                                    <td>
                                        {% set grade = enrollment.course.grades|selectattr('student_id', 'equalto', current_user.id)|first %}
                                        {{ grade.score if grade else '暂无' }}
                                    </td>
                                    <td>
                                        {{ enrollment.operation_count }}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger unenroll-course-btn" data-course-id="{{ enrollment.course.id }}">退出报名</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="grades">
                <div class="card">
                    <div class="card-header">
                        <h4>我的成绩</h4>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>课程名称</th>
                                    <th>成绩</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grade in current_user.grades %}
                                <tr>
                                    <td>{{ grade.course.name }}</td>
                                    <td>{{ grade.score }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 使用事件委托处理报名课程按钮点击事件
    $(document).on('click', '.enroll-course-btn', function() {
        var courseId = $(this).closest('tr').data('course-id');
        if (confirm('确定要报名该课程吗？')) {
            $.ajax({
                url: '/student/course/enroll/' + courseId,
                type: 'POST',
                success: function(response) {
                    alert(response.message);
                    location.reload();
                },
                error: function(xhr) {
                    var errorData = JSON.parse(xhr.responseText);
                    alert('错误: ' + errorData.error);
                }
            });
        }
    });

    // 使用事件委托处理退出报名按钮点击事件
    $(document).on('click', '.unenroll-course-btn', function() {
        var courseId = $(this).data('course-id');
        if (confirm('确定要退出该课程的报名吗？')) {
            $.ajax({
                url: '/student/course/unenroll/' + courseId,
                type: 'POST',
                success: function(response) {
                    alert(response.message);
                    location.reload();
                },
                error: function(xhr) {
                    var errorData = JSON.parse(xhr.responseText);
                    alert('错误: ' + errorData.error);
                }
            });
        }
    });
});
</script>
{% endblock %} 