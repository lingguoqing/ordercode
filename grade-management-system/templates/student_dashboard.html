{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="list-group">
            <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="list">个人信息</a>
            <a href="#grades" class="list-group-item list-group-item-action" data-bs-toggle="list">成绩查询</a>
            <a href="#analysis" class="list-group-item list-group-item-action" data-bs-toggle="list">成绩分析</a>
        </div>
    </div>
    <div class="col-md-9">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="profile">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>个人信息</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                            编辑信息
                        </button>
                    </div>
                    <div class="card-body">
                        <p><strong>用户名：</strong> {{ current_user.username }}</p>
                        <p><strong>姓名：</strong> {{ current_user.name }}</p>
                        <p><strong>邮箱：</strong> {{ current_user.email }}</p>
                        <p><strong>角色：</strong> 学生</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="grades">
                <div class="card">
                    <div class="card-header">
                        <h4>成绩查询</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <select class="form-select" id="courseFilter">
                                <option value="">所有课程</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>课程</th>
                                    <th>教师</th>
                                    <th>成绩</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grade in grades %}
                                <tr>
                                    <td>{{ grade.course.name }}</td>
                                    <td>{{ grade.course.teacher.name }}</td>
                                    <td>{{ grade.score }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info">查看详情</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="analysis">
                <div class="card">
                    <div class="card-header">
                        <h4>成绩分析</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title">成绩分布</h5>
                                        <canvas id="gradeDistribution"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title">课程对比</h5>
                                        <canvas id="courseComparison"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">成绩统计</h5>
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>统计项</th>
                                                    <th>数值</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>平均分</td>
                                                    <td>{{ stats.average }}</td>
                                                </tr>
                                                <tr>
                                                    <td>最高分</td>
                                                    <td>{{ stats.highest }}</td>
                                                </tr>
                                                <tr>
                                                    <td>最低分</td>
                                                    <td>{{ stats.lowest }}</td>
                                                </tr>
                                                <tr>
                                                    <td>及格率</td>
                                                    <td>{{ stats.pass_rate }}%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑个人信息模态框 -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑个人信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="mb-3">
                        <label class="form-label">姓名</label>
                        <input type="text" class="form-control" name="name" value="{{ current_user.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">邮箱</label>
                        <input type="email" class="form-control" name="email" value="{{ current_user.email }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新密码</label>
                        <input type="password" class="form-control" name="new_password">
                        <small class="text-muted">如果不修改密码，请留空</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script>
// 成绩分布图表
const gradeDistributionCtx = document.getElementById('gradeDistribution').getContext('2d');
new Chart(gradeDistributionCtx, {
    type: 'bar',
    data: {
        labels: ['0-60', '60-70', '70-80', '80-90', '90-100'],
        datasets: [{
            label: '成绩分布',
            data: {{ grade_distribution|tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// 课程对比图表
const courseComparisonCtx = document.getElementById('courseComparison').getContext('2d');
new Chart(courseComparisonCtx, {
    type: 'radar',
    data: {
        labels: {{ course_names|tojson }},
        datasets: [{
            label: '成绩对比',
            data: {{ course_scores|tojson }},
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            r: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});
</script>
{% endblock %} 